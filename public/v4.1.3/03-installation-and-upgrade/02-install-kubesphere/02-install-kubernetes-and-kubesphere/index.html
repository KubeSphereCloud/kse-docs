




<!DOCTYPE html>
<html lang="zh"><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">

<meta name="keywords" content="[Kubernetes, {ks_product}, 安装, 安装{ks_product_left}, 安装 Kubernetes]">



<meta name="description" content="介绍如何安装 Kubernetes 和 KubeSphere 企业版。">

<link rel="icon" href="/images/favicon.ico" type="image/x-icon">

<title>离线安装 Kubernetes 和 KubeSphere 企业版 - KubeSphere 企业版</title>
<link href="/css/bulma.css" rel="stylesheet">
<link href="/css/bulma-tooltip.min.css" rel="stylesheet">
<link href="/css/atom-one-light.css" rel="stylesheet" />
<link href="/css/magnific-popup.css" rel="stylesheet" />


<link href="/scss/main.min.3f975d466d577a77f0f174d270294cab5515450a1619ced59c3e7370b108aeb6.css" rel="stylesheet" integrity="sha256-P5ddRm1Xenfw8XTScClMq1UVRQoWGc7VnD5zcLEIrrY=">

<script src="/js/jquery-2.2.4.js"></script>
<body
        class="root   "
        style=""
        ><header>
  <nav class="navbar">
    
      <a href="/" class="navbar-logo-wrapper">
        <img class="navbar-logo" src="/images/qingcloud-logo.svg" />
        <div class="navbar-split navbar-left-split">|</div>
        <div class="navbar-logo-text">KubeSphere 企业版</div>
      </a>
    
    <div class="navbar-nav">
      <div
        class="navbar-nav-item navbar-nav-version "
        style="">
        
        <div class="dropdown-trigger">
          <span class="project-version">
            v4.1.3
          </span>
          
        </div>
        
      </div>
      
    </div>
    <div class="search navbar-search">
      <form action="/v4.1.3/search/" method="GET">
        <div class="control has-icons-left has-icons-right docs-search-input">
          <span class="icon is-left">
            <img src="/images/icons/magnifier_duotone.svg" />
          </span>
          <input
            class="input"
            name="q"
            type="input"
            placeholder="请输入关键字快速获取帮助"
            autocomplete="off"
          />
          <span class="icon is-right"> </span>
        </div>
        <img class="clear-search-input" src="/images/icons/close_duotone.svg" />
      </form>
      <div class="search-result navbar-search-result">
        <div class="search-result-loading"></div>
        <div class="search-result-content"></div>
        <div class="search-result-none">
          没有找到搜索结果， 请更换关键词重新搜索
        </div>
      </div>
    </div>
    
  </nav>
</header><script id="search-result-total-template" type="text/x-js-template">
  <div class="search-result-total">
    共为您找到 ${count} 个结果
  </div>
</script>

<script id="search-result-item-template" type="text/x-js-template">
  <div class="search-result-content-item">
    <div class="search-result-content-item-title">
      <a href="${href}">${title}</a>
    </div>
    <div class="search-result-content-item-content">
      ${content}
    </div>
    <div class="search-result-content-item-ref">
      <ul class="content-breadcrumb">
      </ul>
    </div>
  </div>
</div>
</script>

<script id="search-breadcrumb-template" type="text/x-js-template">
  <li class="icon-slash_fill">
    <a href="${href}">${title}</a>
  </li>
</script>

<script id="search-result-total-template" type="text/x-js-template">
  <div class="search-result-total">
    共为您找到 ${count} 个结果
  </div>
</script>
<script id="search-result-page-template" type="text/x-js-template">
  <nav class="search-result-pagination pagination is-centered">
    <a class="pagination-previous icon-chevron_left_fill"></a>
    <a class="pagination-next icon-chevron_right_fill"></a>
    <ul class="pagination-list">
    </ul>
  </nav>
</script>
<div class="container">

  


  
    
  


<aside class="sidebar-wrapper">
  <div class="sidebar-drag"></div>
  <div class="sidebar">
    
      <div class="sidebar-title" >
        <a href="/v4.1.3/">
          
            KubeSphere 企业版
        </a>
        
      </div>
      
    
    <nav class="sidebar-menu">
      
        
        <ul>
  
  
    
      
      
      
      
        
          <li
            class="sidebar-item active ">
            <a href="/v4.1.3/03-installation-and-upgrade/">安装指南</a>
            
            
              
                
                  
                
              
            
              
                
                  
                
              
            
              
                
                  
                
              
            
              
                
                  
                
              
            
              
                
                  
                
              
            
            
              <span
                class="menu-switch-icon icon-caret_up_fill">
              </span>
            
          </li>
          
          <ul>
  
  
    
      
      
      
      
        
          <li
            class="sidebar-item collapsed ">
            <a href="/v4.1.3/03-installation-and-upgrade/01-preparations/">准备工作</a>
            
            
              
                
                  
                
              
            
              
                
                  
                
              
            
              
                
                  
                
              
            
            
              <span
                class="menu-switch-icon icon-caret_down_fill">
              </span>
            
          </li>
          
          <ul>
  
  
    
      
      
      
      
          <li class="sidebar-item">
            <a href="/v4.1.3/03-installation-and-upgrade/01-preparations/01-supported-k8s/">环境要求</a>
          </li>
        
      
    
  
    
      
      
      
      
          <li class="sidebar-item">
            <a href="/v4.1.3/03-installation-and-upgrade/01-preparations/03-configure-high-availability/">配置高可用性</a>
          </li>
        
      
    
  
    
      
      
      
      
        
          <li
            class="sidebar-item collapsed ">
            <a href="/v4.1.3/03-installation-and-upgrade/01-preparations/04-configure-external-persistent-storage/">配置外部持久化存储</a>
            
            
              
                
                  
                
              
            
              
                
                  
                
              
            
              
                
                  
                
              
            
              
                
                  
                
              
            
            
              <span
                class="menu-switch-icon icon-caret_down_fill">
              </span>
            
          </li>
          
          <ul>
  
  
    
      
      
      
      
          <li class="sidebar-item">
            <a href="/v4.1.3/03-installation-and-upgrade/01-preparations/04-configure-external-persistent-storage/01-configure-storage-devices-on-cloud/">配置云上存储设备</a>
          </li>
        
      
    
  
    
      
      
      
      
          <li class="sidebar-item">
            <a href="/v4.1.3/03-installation-and-upgrade/01-preparations/04-configure-external-persistent-storage/04-configure-neosan-csi/">配置 NeonSAN CSI</a>
          </li>
        
      
    
  
    
      
      
      
      
          <li class="sidebar-item">
            <a href="/v4.1.3/03-installation-and-upgrade/01-preparations/04-configure-external-persistent-storage/05-configure-nfs/">配置 NFS</a>
          </li>
        
      
    
  
    
      
      
      
      
          <li class="sidebar-item">
            <a href="/v4.1.3/03-installation-and-upgrade/01-preparations/04-configure-external-persistent-storage/07-configure-opensource-storage/">配置开源存储系统</a>
          </li>
        
      
    
  
</ul>
        
      
    
  
</ul>
        
      
    
  
    
      
      
      
      
        
          <li
            class="sidebar-item active ">
            <a href="/v4.1.3/03-installation-and-upgrade/02-install-kubesphere/">安装 KubeSphere 企业版</a>
            
            
              
                
                  
                
              
            
              
                
                  
                
              
            
              
                
                  
                
              
            
              
                
                  
                
              
            
            
              <span
                class="menu-switch-icon icon-caret_up_fill">
              </span>
            
          </li>
          
          <ul>
  
  
    
      
      
      
      
          <li class="sidebar-item">
            <a href="/v4.1.3/03-installation-and-upgrade/02-install-kubesphere/01-online-install-kubernetes-and-kubesphere/">在线安装 Kubernetes 和 KubeSphere 企业版</a>
          </li>
        
      
    
  
    
      
      
      
      
          <li class="sidebar-item">
            <a href="/v4.1.3/03-installation-and-upgrade/02-install-kubesphere/02-install-kubernetes-and-kubesphere/">离线安装 Kubernetes 和 KubeSphere 企业版</a>
          </li>
        
      
    
  
    
      
      
      
      
          <li class="sidebar-item">
            <a href="/v4.1.3/03-installation-and-upgrade/02-install-kubesphere/03-activate-kse/">激活 KubeSphere 企业版</a>
          </li>
        
      
    
  
    
      
      
      
      
          <li class="sidebar-item">
            <a href="/v4.1.3/03-installation-and-upgrade/02-install-kubesphere/05-appendix/">附录：KubeSphere Core 高级配置</a>
          </li>
        
      
    
  
</ul>
        
      
    
  
    
      
      
      
      
        
          <li
            class="sidebar-item collapsed ">
            <a href="/v4.1.3/03-installation-and-upgrade/03-upgrade-kubesphere/">升级 KubeSphere 企业版</a>
            
            
              
                
                  
                
              
            
            
              <span
                class="menu-switch-icon icon-caret_down_fill">
              </span>
            
          </li>
          
          <ul>
  
  
    
      
      
      
      
          <li class="sidebar-item">
            <a href="/v4.1.3/03-installation-and-upgrade/03-upgrade-kubesphere/05-appendix-ks-core/">附录 1：ks-core Helm Chart 升级参数</a>
          </li>
        
      
    
  
</ul>
        
      
    
  
    
      
      
      
      
        
          <li
            class="sidebar-item collapsed ">
            <a href="/v4.1.3/03-installation-and-upgrade/04-uninstall-kubesphere/">卸载 KubeSphere 企业版</a>
            
            
              
                
                  
                
              
            
              
                
                  
                
              
            
            
              <span
                class="menu-switch-icon icon-caret_down_fill">
              </span>
            
          </li>
          
          <ul>
  
  
    
      
      
      
      
          <li class="sidebar-item">
            <a href="/v4.1.3/03-installation-and-upgrade/04-uninstall-kubesphere/01-uninstall-kubesphere-only/">仅卸载 KubeSphere 企业版</a>
          </li>
        
      
    
  
    
      
      
      
      
          <li class="sidebar-item">
            <a href="/v4.1.3/03-installation-and-upgrade/04-uninstall-kubesphere/02-uninstall-kubernetes-and-kubesphere/">卸载 Kubernetes 和 KubeSphere 企业版</a>
          </li>
        
      
    
  
</ul>
        
      
    
  
    
      
      
      
      
        
          <li
            class="sidebar-item collapsed ">
            <a href="/v4.1.3/03-installation-and-upgrade/05-add-and-delete-cluster-nodes/">添加和删除集群节点</a>
            
            
              
                
                  
                
              
            
              
                
                  
                
              
            
            
              <span
                class="menu-switch-icon icon-caret_down_fill">
              </span>
            
          </li>
          
          <ul>
  
  
    
      
      
      
      
          <li class="sidebar-item">
            <a href="/v4.1.3/03-installation-and-upgrade/05-add-and-delete-cluster-nodes/01-add-cluster-nodes/">添加集群节点</a>
          </li>
        
      
    
  
    
      
      
      
      
          <li class="sidebar-item">
            <a href="/v4.1.3/03-installation-and-upgrade/05-add-and-delete-cluster-nodes/02-delete-cluster-nodes/">删除集群节点</a>
          </li>
        
      
    
  
</ul>
        
      
    
  
</ul>
        
      
    
  
    
  
</ul>
      
    </nav>

  </div>
</aside>
<div class="content-card-wrapper">
  <div class="content-card">
    <div class="content-wrapper"><ul class="content-breadcrumb">
      <li class="icon-slash_fill"><a href="/v4.1.3" data-url="/v4.1.3">KubeSphere 企业版</a></li>
      <li class="icon-slash_fill"><a href="/v4.1.3/03-installation-and-upgrade" data-url="/v4.1.3/03-installation-and-upgrade">安装指南</a></li>
      <li class="icon-slash_fill"><a href="/v4.1.3/03-installation-and-upgrade/02-install-kubesphere" data-url="/v4.1.3/03-installation-and-upgrade/02-install-kubesphere">安装 KubeSphere 企业版</a></li>
      <li class="icon-slash_fill"><a href="/v4.1.3/03-installation-and-upgrade/02-install-kubesphere/02-install-kubernetes-and-kubesphere" data-url="/v4.1.3/03-installation-and-upgrade/02-install-kubesphere/02-install-kubernetes-and-kubesphere">离线安装 Kubernetes 和 KubeSphere 企业版</a></li></ul><div class="post-wrapper"><div class="post">
  <h1 class="post-title">
    离线安装 Kubernetes 和 KubeSphere 企业版</h1>
  <div class="post-info">
    <div class="post-date">
      更新时间：2025-05-06 07:46:54
    </div>
    
    
    
    
    
    
      
    
    
  </div><div class="post-menu">
  <div class="post-menu-title">本页目录</div>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#_前提条件">前提条件</a></li>
    <li><a href="#_配置防火墙规则">配置防火墙规则</a></li>
    <li><a href="#_安装依赖项">安装依赖项</a></li>
    <li><a href="#_校验安装包完整性">校验安装包完整性</a></li>
    <li><a href="#_查看安装包内容">查看安装包内容</a></li>
    <li><a href="#_配置安装配置文件">配置安装配置文件</a></li>
    <li><a href="#_创建私有镜像仓库">创建私有镜像仓库</a></li>
    <li><a href="#_安装_kubernetes">安装 Kubernetes</a></li>
    <li><a href="#_导入镜像到私有镜像仓库">导入镜像到私有镜像仓库</a></li>
    <li><a href="#_安装kubesphere企业版">安装 KubeSphere 企业版</a></li>
  </ul>
</nav>
</div><div class="post-content">
    
      
      
<div class="paragraph">
<p>本节介绍如何离线安装 Kubernetes 和 KubeSphere 企业版。部署环境无需访问外网，可完全离线安装 KubeSphere 企业版和扩展组件。</p>
</div>
<div class="paragraph">
<p>安装过程中将用到开源工具 KubeKey。有关 KubeKey 的更多信息，请访问 <a href="https://github.com/kubesphere/kubekey">GitHub KubeKey 仓库</a>。</p>
</div>
<div class="sect1">
<h2 id="_前提条件">前提条件</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>您需要联系 KubeSphere 企业版的交付服务专家获取 KubeSphere 企业版 v4.1.3 安装包。</p>
</li>
<li>
<p>您需要准备至少 1 台 Linux 服务器作为集群节点。在生产环境中，为确保集群具备高可用性，建议准备至少 5 台 Linux 服务器，其中 3 台作为控制平面节点，另外 2 台作为工作节点。如果您在多台 Linux 服务器上安装 KubeSphere 企业版，请确保所有服务器属于同一子网。</p>
</li>
<li>
<p>集群节点的操作系统和版本须为 Ubuntu 16.04、Ubuntu 18.04、Ubuntu 20.04、Ubuntu 22.04、Debian 9、Debian 10、CentOS 7、CentOS Stream、RHEL 7、RHEL 8、SLES 15 或 openSUSE Leap 15。多台服务器的操作系统可以不同。关于其它操作系统和版本支持，请咨询青云科技官方解决方案专家或交付服务专家。</p>
</li>
<li>
<p>在生产环境中，为确保集群具有足够的计算和存储资源，建议每台集群节点配置至少 8 个 CPU 核心、16 GB 内存和 200 GB 磁盘空间。除此之外，建议在每台集群节点的 <strong>/var/lib/docker</strong>（对于 Docker）或 <strong>/var/lib/containerd</strong>（对于 containerd） 目录额外挂载至少 200 GB 磁盘空间用于存储容器运行时数据。</p>
</li>
<li>
<p>除集群节点外，您还需要准备一台 Linux 服务器用于创建私有镜像服务，该服务器必须与 KubeSphere 企业版集群节点网络连通，并且在 <strong>/mnt/registry</strong> 目录挂载至少 100 GB 磁盘空间。</p>
</li>
<li>
<p>在生产环境中，建议提前为 KubeSphere 企业版集群配置高可用性以避免单个控制平面节点出现故障时集群服务中断。有关更多信息，请参阅<a href="../../../03-installation-and-upgrade/01-preparations/03-configure-high-availability/">配置高可用性</a>。</p>
<div class="openblock">
<div class="content">
<table class="tableblock frame-all grid-all stretch admon note">
<colgroup>
<col style="width: 100%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>如果您规划了多个控制平面节点，请务必提前为集群配置高可用性。</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</li>
<li>
<p>默认情况下，KubeSphere 企业版使用集群节点的本地磁盘空间作为持久化存储。在生产环境中，建议提前配置外部存储系统作为持久化存储。有关更多信息，请参阅<a href="../../../03-installation-and-upgrade/01-preparations/04-configure-external-persistent-storage/">配置外部持久化存储</a>。</p>
</li>
<li>
<p>如果集群节点未安装容器运行时，安装工具 KubeKey 将在安装过程中自动为每个集群节点安装 Docker 作为容器运行时。您也可以提前手动安装 containerd、CRI-O 或 iSula 作为容器运行时。</p>
<div class="openblock">
<div class="content">
<table class="tableblock frame-all grid-all stretch admon note">
<colgroup>
<col style="width: 100%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>CRI-O 和 iSula 与 KubeSphere 企业版的兼容性尚未经过充分测试，可能存在未知问题。</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</li>
<li>
<p>请确保所有集群节点上 <strong>/etc/resolv.conf</strong> 文件中配置的 DNS 服务器地址可用。否则，KubeSphere 企业版集群可能会出现域名解析问题。</p>
</li>
<li>
<p>请确保在所有集群节点上都可以使用 <strong>sudo</strong>、<strong>curl</strong> 和 <strong>openssl</strong> 命令。</p>
</li>
<li>
<p>请确保所有集群节点时间同步。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_配置防火墙规则">配置防火墙规则</h2>
<div class="sectionbody">
<div class="paragraph">
<p>KubeSphere 企业版需要特定端口和协议用于服务之间的通信。如果您的基础设施环境已启用防火墙，您需要在防火墙设置中放行所需的端口和协议。如果您的基础设施环境未启用防火墙，您可以跳过此步骤。</p>
</div>
<div class="paragraph">
<p>下表列出需要在防火墙中放行的端口和协议。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;"/>
<col style="width: 16.6666%;"/>
<col style="width: 16.6666%;"/>
<col style="width: 16.6666%;"/>
<col style="width: 33.3336%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">服务</th>
<th class="tableblock halign-left valign-top">协议</th>
<th class="tableblock halign-left valign-top">起始端口</th>
<th class="tableblock halign-left valign-top">结束端口</th>
<th class="tableblock halign-left valign-top">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>ssh</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>TCP</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>22</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>etcd</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>TCP</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>2379</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>2380</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>apiserver</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>TCP</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>6443</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>calico</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>TCP</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>9099</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>9100</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>bgp</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>TCP</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>179</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>nodeport</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>TCP</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>30000</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>32767</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>master</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>TCP</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>10250</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>10258</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>dns</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>TCP</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>53</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>dns</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>UDP</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>53</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>metrics-server</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>TCP</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>8443</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>local-registry</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>TCP</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>5000</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>离线环境需要</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>local-apt</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>TCP</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>5080</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>离线环境需要</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>rpcbind</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>TCP</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>111</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>使用 NFS 作为持久化存储时需要</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>ipip</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>IPENCAP/IPIP</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>使用 Calico 时需要</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_安装依赖项">安装依赖项</h2>
<div class="sectionbody">
<div class="paragraph">
<p>您需要为所有集群节点安装 socat、conntrack、ebtables 和 ipset。如果上述依赖项在各集群节点上已存在，您可以跳过此步骤。</p>
</div>
<div class="paragraph">
<p>在 Ubuntu 操作系统上，执行以下命令为服务器安装依赖项：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">sudo apt install socat conntrack ebtables ipset -y</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果集群节点使用其他操作系统，请将 <strong>apt</strong> 替换为操作系统对应的软件包管理工具。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_校验安装包完整性">校验安装包完整性</h2>
<div class="sectionbody">
<div class="paragraph">
<p>获取 KubeSphere 企业版安装包后，可采用校验文件哈希值的方法验证安装包的完整性，以确保其没有被损坏。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>根据安装包文件所在的操作系统，执行对应的命令，查看安装包的 SHA256 值。</p>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Windows 系统</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">certutil -hashfile [file location] SHA256</code></pre>
</div>
</div>
<div class="paragraph">
<p>示例：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">certutil -hashfile C:\Users\user1\Downloads\kse-v4.1.3-offline-linux-amd64-all-20250225.tar.gz SHA256</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Linux 系统</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sha256sum [file location]</code></pre>
</div>
</div>
<div class="paragraph">
<p>示例：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sha256sum ~/Downloads/kse-v4.1.3-offline-linux-amd64-all-20250225.tar.gz</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>MacOS 系统</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">shasum -a 256 [file location]</code></pre>
</div>
</div>
<div class="paragraph">
<p>示例：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">shasum -a 256 ~/Downloads/kse-v4.1.3-offline-linux-amd64-all-20250225.tar.gz</code></pre>
</div>
</div>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>与安装包中的 SHA256 值进行比对，确保上一步得到的 SHA256 与其一致。</p>
<div class="openblock">
<div class="content">
<table class="tableblock frame-all grid-all stretch admon attention">
<colgroup>
<col style="width: 100%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">注意</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>如果 SHA256 不一致，您需要重新获取完整的 KubeSphere 企业版安装包。</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_查看安装包内容">查看安装包内容</h2>
<div class="sectionbody">
<div class="paragraph">
<p>了解 KubeSphere 企业版 v4.1.3 的安装包内容，以便进行后续步骤。</p>
</div>
<div class="paragraph">
<p>安装包包含以下文件：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kse-v4.1.3-offline-linux-amd64-all/
├── charts
│   ├── ks-core                   # KubeSphere 企业版核心组件
│   └── nfs-client-provisioner    # 用于对接 NFS 存储
├── tools
│   ├── extension-resources-patch.sh   # 用于处理 v4.1.2 及之前版本通过 kse-extension-publish 创建的扩展组件资源产生的冲突
│   └── oras                      # OCI 工具，便于镜像同步等操作
├── kse-extensions                # 其中包含所有扩展组件的 installplan，可用于快速安装 KubeSphere 企业版扩展组件
├── config-sample.yaml            # 安装配置文件的模版
├── create_project_harbor.sh      # 用于快速创建 harbor 项目
├── kk                            # 集群部署工具
├── kubekey-artifact.tar.gz       # KubeSphere 企业版制品，其中包含集群部署所需的二进制文件及镜像
└── manifest-v413-amd64.yaml      # KubeSphere 企业版制品清单，其中包含各组件的版本以及镜像列表</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_配置安装配置文件">配置安装配置文件</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>config-sample.yaml</strong> 是 KubeSphere 企业版的安装配置文件，请先配置该文件，以便进行后续步骤。</p>
</div>
<table class="tableblock frame-all grid-all stretch admon note">
<colgroup>
<col style="width: 100%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>安装完成后，请勿删除安装配置文件 <strong>config-sample.yaml</strong>，后续进行节点添加等操作时仍需要使用该文件。如果该文件丢失，您需要重新创建安装配置文件。</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>将 KubeSphere 企业版安装包传输到任意集群节点，并登录该集群节点。</p>
</li>
<li>
<p>执行以下命令解压安装包，并进入安装包解压后生成的目录（将 &lt;package name&gt; 替换为安装包的实际名称，将 &lt;directory&gt; 替换为安装包解压后生成的目录）：</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">tar -zxvf &lt;package name&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">cd &lt;directory&gt;</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>执行以下命令为 KubeKey 二进制文件 <strong>kk</strong> 添加执行权限：</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">sudo chmod +x kk</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>执行以下命令编辑安装配置文件 <strong>config-sample.yaml</strong>：</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">vi config-sample.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下为部分示例配置文件，如需了解完整示例，请参阅<a href="https://github.com/kubesphere/kubekey/blob/master/docs/config-example.md">此文件</a>。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: kubekey.kubesphere.io/v1alpha2
kind: Cluster
metadata:
  name: sample
spec:
  hosts:
  - {name: controlplane1, address: 192.168.0.2, internalAddress: 192.168.0.2, port: 23, user: ubuntu, password: Testing123, arch: arm64} # arm64 节点注意添加参数 arch: arm64
  - {name: controlplane2, address: 192.168.0.3, internalAddress: 192.168.0.3, user: ubuntu, privateKeyPath: &#34;~/.ssh/id_rsa&#34;}
  - {name: worker1, address: 192.168.0.4, internalAddress: 192.168.0.4, user: ubuntu, password: Testing123}
  - {name: worker2, address: 192.168.0.5, internalAddress: 192.168.0.5, user: ubuntu, password: Testing123}
  - {name: registry, address: 192.168.0.6, internalAddress: 192.168.0.6, user: ubuntu, password: Testing123}
  roleGroups:
    etcd:
    - controlplane1
    - controlplane2
    control-plane:
    - controlplane1
    - controlplane2
    worker:
    - worker1
    - worker2
    # 如需使用 kk 自动部署镜像仓库，请设置 registry（建议镜像仓库与集群节点分离部署，减少相互影响）
    registry:
    - registry
  controlPlaneEndpoint:
    internalLoadbalancer: haproxy # 如需部署⾼可⽤集群，且⽆负载均衡器可⽤，可开启该参数，做集群内部负载均衡
    domain: lb.kubesphere.local
    address: &#34;&#34;
    port: 6443
  kubernetes:
    version: v1.23.15
    clusterName: cluster.local
  network:
    plugin: calico
    kubePodsCIDR: 10.233.64.0/18
    kubeServiceCIDR: 10.233.0.0/18
    ## multus support. https://github.com/k8snetworkplumbingwg/multus-cni
    enableMultusCNI: false
  registry:
    # 如需使用 kk 部署 harbor，可将该参数设置为 harbor，不设置该参数且需使用 kk 部署容器镜像仓库，将默认部署 docker registry。
    # harbor 不支持 arm64，arm64 环境部署时，可不配置该参数。
    type: harbor
    # 如使用 kk 部署的 harbor 或其他需要登录的仓库，需设置对应仓库的 auths，如使用 kk 部署默认的 docker registry 仓库，则无需配置 auths 参数。
    # 注意：如使用 kk 部署 harbor，auths 参数请于创建 harbor 项目之后设置。
    auths:
      &#34;dockerhub.kubekey.local&#34;:
        username: admin # harbor 默认用户名
        password: Harbor12345 # harbor 默认密码
        plainHTTP: false  # 如果仓库使用 http，请将该参数设置为 true
    privateRegistry: &#34;dockerhub.kubekey.local/kse&#34;   # 设置集群部署时使用的私有仓库地址
    registryMirrors: []
    insecureRegistries: []
  addons: []</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>在 <strong>config-sample.yaml</strong> 配置文件的 <strong>spec:hosts</strong> 参数下设置各服务器的信息。</p>
<div class="openblock">
<div class="content">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;"/>
<col style="width: 80%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">参数</th>
<th class="tableblock halign-left valign-top">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>name</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>用户自定义的服务器名称。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>address</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>服务器的 SSH 登录 IP 地址。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>internalAddress</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>服务器在子网内部的 IP 地址。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>port</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>服务器的 SSH 端口号。如果使用默认端口 22 可不设置此参数。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>user</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>服务器的 SSH 登录用户名，该用户必须为 <strong>root</strong> 用户或其他具有 <strong>sudo</strong> 命令执行权限的用户。如果使用 <strong>root</strong> 用户可不设置此参数。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>password</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>服务器的 SSH 登录密码。如果已经设置 <strong>privateKeyPath</strong> 可不设置此参数。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>privateKeyPath</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>服务器的 SSH 登录密钥的路径。如果已经设置 <strong>password</strong> 可不设置此参数。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>arch</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>服务器的硬件架构。如果服务器的硬件架构为 arm64，请将此参数设置为 <strong>arm64</strong>，否则请勿设置此参数。安装包默认仅支持所有集群节点都为 x86_64 或 arm64 架构的场景。如果某集群节点的硬件架构不完全相同，需针对具体情况进行技术评估，请咨询青云科技官方解决方案专家或交付服务专家。</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</li>
<li>
<p>在 <strong>config-sample.yaml</strong> 配置文件的 <strong>spec:roleGroups</strong> 参数下设置服务器的角色：</p>
<div class="openblock">
<div class="content">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;"/>
<col style="width: 80%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">参数</th>
<th class="tableblock halign-left valign-top">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>etcd</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>安装 etcd 数据库的节点。请在此参数下设置集群控制平面节点。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>control-plane</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>集群控制平面节点。如果您已经为集群配置了高可用性，您可以设置多个控制平面节点。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>worker</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>集群工作节点。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>registry</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>用于创建私有镜像服务的服务器。该服务器不会用作集群节点。
安装、升级 KubeSphere 企业版时，如果集群节点无法连接互联网，需要在此参数下设置用于创建私有镜像服务的服务器。其他情况下请将此参数注释掉。</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</li>
<li>
<p>如果您规划了多个控制平面节点，在 <strong>config-sample.yaml</strong> 配置文件的 <strong>spec:controlPlaneEndpoint</strong> 参数下设置高可用性信息。</p>
<div class="openblock">
<div class="content">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;"/>
<col style="width: 80%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">参数</th>
<th class="tableblock halign-left valign-top">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>internalLoadbalancer</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>本地负载均衡器的类型。如果使用本地负载均衡配置，请将此参数设置为 <strong>haproxy</strong>。否则，请将此参数注释掉。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>domain</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>负载均衡器的内部访问域名。请将此参数设置为 <strong>lb.kubesphere.local</strong>。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>address</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>负载均衡器的 IP 地址。如果使用本地负载均衡配置，请将此参数留空；如果使用专用负载均衡器，请将此参数设置为负载均衡器的 IP 地址；如果使用通用服务器作为负载均衡器，请将此参数设置为负载均衡器的浮动 IP 地址。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>port</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>负载均衡器监听的端口号，即 apiserver 服务的端口号。请将此参数设置为 <strong>6443</strong>。</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</li>
<li>
<p>如果您需要使用外部持久化存储，在 <strong>config-sample.yaml</strong> 配置文件的 <strong>spec:addons</strong> 参数下设置外部持久化存储信息。</p>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>如果使用云上存储设备，在 <strong>spec:addons</strong> 下设置以下参数（将 &lt;configuration file path&gt; 替换为存储插件配置文件的实际路径）：</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">  - name: csi-qingcloud
    namespace: kube-system
    sources:
      chart:
        name: csi-qingcloud
        path: charts/csi-qingcloud  # 替换为 chart 包的实际路径
        valuesFile: &lt;configuration file path&gt;</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>如果使用 NeonSAN 存储设备，在 <strong>spec:addons</strong> 下设置以下参数（将 &lt;configuration file path&gt; 替换为存储插件配置文件的实际路径）：</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">  - name: csi-neonsan
    namespace: kube-system
    sources:
      chart:
        name: csi-neonsan
        path: charts/csi-neonsan  # 替换为 chart 包的实际路径
        valuesFile: &lt;configuration file path&gt;</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>如果使用 NFS 存储系统，在 <strong>spec:addons</strong> 下设置以下参数（将 &lt;configuration file path&gt; 替换为存储插件配置文件的实际路径）：</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">  - name: nfs-client
    namespace: kube-system
    sources:
      chart:
        name: nfs-client-provisioner
        repo: charts/nfs-client-provisioner
        valuesFile: &lt;configuration file path&gt;</code></pre>
</div>
</div>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_创建私有镜像仓库">创建私有镜像仓库</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch admon attention">
<colgroup>
<col style="width: 100%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">注意</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>如果您已有可用的镜像仓库，可跳过此步骤。但需要把私有镜像服务的默认地址 <strong>dockerhub.kubekey.local/kse</strong> 替换为您的实际镜像仓库地址。</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在配置文件 <strong>config-sample.yaml</strong> 的 <strong>spec:hosts</strong> 参数下设置用于创建私有镜像服务的服务器的信息。</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spec:
  hosts:
  - {name: registry, address: 192.168.0.6, internalAddress: 192.168.0.6, user: ubuntu, password: Testing123}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;"/>
<col style="width: 80%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">参数</th>
<th class="tableblock halign-left valign-top">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>name</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>用户自定义的服务器名称。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>address</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>服务器的 SSH 登录 IP 地址。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>internalAddress</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>服务器在子网内部的 IP 地址。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>port</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>服务器的 SSH 端口号。如果使用默认端口 22 可不设置此参数。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>user</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>服务器的 SSH 登录用户名，该用户必须为 <strong>root</strong> 用户或其他具有 <strong>sudo</strong> 命令执行权限的用户。如果使用 <strong>root</strong> 用户可不设置此参数。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>password</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>服务器的 SSH 登录密码。如果已经设置 <strong>privateKeyPath</strong> 可不设置此参数。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>privateKeyPath</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>服务器的 SSH 登录密钥的路径。如果已经设置 <strong>password</strong> 可不设置此参数。</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>arch</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>服务器的硬件架构。如果服务器的硬件架构为 arm64，请将此参数设置为 <strong>arm64</strong>，否则请勿设置此参数。安装包默认仅支持所有集群节点都为 x86_64 或 arm64 架构的场景。如果某集群节点的硬件架构不完全相同，需针对具体情况进行技术评估，请咨询青云科技官方解决方案专家或交付服务专家。</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</li>
<li>
<p>在 <strong>spec:roleGroups:registry</strong> 参数下设置用于创建私有镜像服务的服务器名称（将 &lt;registry name&gt; 替换为 <strong>spec:hosts</strong> 参数下设置的服务器实际名称）。</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spec:
  roleGroups:
    registry:
    - &lt;registry name&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>将 <strong>spec:registry:privateRegistry</strong> 参数设置为私有镜像服务的默认地址 <strong>dockerhub.kubekey.local/kse</strong>，然后保存文件。</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spec:
  registry:
    registryMirrors: []
    insecureRegistries: []
    privateRegistry: dockerhub.kubekey.local/kse</code></pre>
</div>
</div>
</li>
<li>
<p>执行以下命令初始化私有镜像服务：</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./kk init registry -f config-sample.yaml -a kubekey-artifact.tar.gz</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果显示如下信息，则表明镜像仓库创建成功。</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/ks-qkcp/zh/v4.1/verify-registry.png" alt="verify-registry" width="100%"/></span></p>
</div>
<table class="tableblock frame-all grid-all stretch admon note">
<colgroup>
<col style="width: 100%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>KubeKey 将在 <strong>config-sample.yaml</strong> 配置文件中 <strong>spec:roleGroups:registry</strong> 参数指定的服务器上创建私有镜像服务，默认地址为 <strong>dockerhub.kubekey.local/kse</strong>。</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</li>
<li>
<p>若 <strong>spec:registry:type</strong> 参数设置为 <strong>harbor</strong>，执行以下命令创建 Harbor 项目。</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">bash create_project_harbor.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>创建 harbor 项目后，在 <strong>config-sample.yaml</strong> 中配置 <strong>spec:registry:auths</strong> 参数。</p>
</div>
<table class="tableblock frame-all grid-all stretch admon note">
<colgroup>
<col style="width: 100%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>harbor 安装文件在 /opt/harbor 目录下，可在该目录下对 harbor 进行运维。</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</li>
<li>
<p>如果同时满足以下条件，需执行以下步骤在 harbor 所在节点添加 containerd 配置。</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>镜像仓库使用 harbor</p>
</li>
<li>
<p>容器运行时为 containerd</p>
</li>
<li>
<p>harbor 所在节点也在待部署的集群中</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mkdir /etc/containerd</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 创建 containerd 配置文件
# 注意修改 sandbox_image 以及 [plugins.&#34;io.containerd.grpc.v1.cri&#34;.registry.configs]
# 下的仓库信息为实际环境信息

cat &lt;&lt;EOF &gt; /etc/containerd/config.toml
version = 2
root = &#34;/var/lib/containerd&#34;
state = &#34;/run/containerd&#34;

[grpc]
  address = &#34;/run/containerd/containerd.sock&#34;
  uid = 0
  gid = 0
  max_recv_message_size = 16777216
  max_send_message_size = 16777216

[ttrpc]
  address = &#34;&#34;
  uid = 0
  gid = 0

[debug]
  address = &#34;&#34;
  uid = 0
  gid = 0
  level = &#34;&#34;

[metrics]
  address = &#34;&#34;
  grpc_histogram = false

[cgroup]
  path = &#34;&#34;

[timeouts]
  &#34;io.containerd.timeout.shim.cleanup&#34; = &#34;5s&#34;
  &#34;io.containerd.timeout.shim.load&#34; = &#34;5s&#34;
  &#34;io.containerd.timeout.shim.shutdown&#34; = &#34;3s&#34;
  &#34;io.containerd.timeout.task.state&#34; = &#34;2s&#34;

[plugins]
  [plugins.&#34;io.containerd.grpc.v1.cri&#34;.containerd.runtimes.runc]
    runtime_type = &#34;io.containerd.runc.v2&#34;
    [plugins.&#34;io.containerd.grpc.v1.cri&#34;.containerd.runtimes.runc.options]
      SystemdCgroup = true
  [plugins.&#34;io.containerd.grpc.v1.cri&#34;]
    sandbox_image = &#34;dockerhub.kubekey.local/kse/kubesphere/pause:3.6&#34;
    [plugins.&#34;io.containerd.grpc.v1.cri&#34;.cni]
      bin_dir = &#34;/opt/cni/bin&#34;
      conf_dir = &#34;/etc/cni/net.d&#34;
      max_conf_num = 1
      conf_template = &#34;&#34;
    [plugins.&#34;io.containerd.grpc.v1.cri&#34;.registry]
      [plugins.&#34;io.containerd.grpc.v1.cri&#34;.registry.mirrors]
        [plugins.&#34;io.containerd.grpc.v1.cri&#34;.registry.mirrors.&#34;docker.io&#34;]
          endpoint = [&#34;https://registry-1.docker.io&#34;]
        [plugins.&#34;io.containerd.grpc.v1.cri&#34;.registry.configs]
          [plugins.&#34;io.containerd.grpc.v1.cri&#34;.registry.configs.&#34;dockerhub.kubekey.local&#34;.auth]
            username = &#34;admin&#34;
            password = &#34;harbor2345&#34;
            [plugins.&#34;io.containerd.grpc.v1.cri&#34;.registry.configs.&#34;dockerhub.kubekey.local&#34;.tls]
              ca_file = &#34;&#34;
              cert_file = &#34;&#34;
              key_file = &#34;&#34;
              insecure_skip_verify = true
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 重启 containerd
systemctl restart containerd</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>登录所有集群节点，执行以下命令编辑 <strong>/etc/hosts</strong> 文件：</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">vi /etc/hosts</code></pre>
</div>
</div>
<div class="paragraph">
<p>在 <strong>/etc/hosts</strong> 文件中添加以下信息，从而为集群节点配置私有镜像服务的域名解析规则（将 &lt;registry IP address&gt; 替换成私有镜像服务的实际 IP 地址，将私有镜像服务的默认地址 <strong>dockerhub.kubekey.local</strong> 替换为您的实际镜像仓库地址），然后保存文件：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">&lt;registry IP address&gt; dockerhub.kubekey.local</code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_安装_kubernetes">安装 Kubernetes</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch admon note">
<colgroup>
<col style="width: 100%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>如果您已有可用的 Kubernetes 集群，可跳过此步骤。</p>
</li>
<li>
<p>安装包中集成了 CentOS 7、Ubuntu 18.04、Ubuntu 20.04、Ubuntu 22.04 依赖包，如使用这些操作系统需要使用 kk 自动安装系统依赖，可在安装命令后添加 --with-packages ; 如使用这些操作系统之外的操作系统或由于依赖问题导致失败，需手动安装相关依赖（conntrack）。</p>
</li>
<li>
<p>如需使用 openebs localpv，可在如下命令后添加参数 --with-local-storage，如需对接其他存储，可在配置文件 addons 中添加配置相关存储插件，或 Kubernetes 集群部署完成后自行安装。</p>
</li>
<li>
<p>如使用 kk 部署的 harbor，请确保安装 Kubernetes 之前，已创建 harbor 项目，且配置文件 config-sample.yaml 中已配置 spec:registry:auths 参数。</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>执行以下命令创建 Kubernetes 集群：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell"> ./kk create cluster -f config-sample.yaml -a kubekey-artifact.tar.gz</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果显示如下信息，则表明 Kubernetes 集群创建成功。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">Pipeline[CreateclusterPipeline] execute successfully
Installation is complete.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_导入镜像到私有镜像仓库">导入镜像到私有镜像仓库</h2>
<div class="sectionbody">
<div class="paragraph">
<p>执行以下命令将镜像导入到指定的私有镜像仓库中。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./kk artifact images push  -f config-sample.yaml -a kubekey-artifact.tar.gz</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果显示如下信息，则表明导入成功。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">Pipeline[ArtifactImagesPushPipeline] execute successfully</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_安装kubesphere企业版">安装 KubeSphere 企业版</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在集群节点，执行以下命令安装 KubeSphere Core。</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">helm upgrade --install -n kubesphere-system --create-namespace ks-core charts/ks-core \
--debug \
--wait \
--set global.imageRegistry=dockerhub.kubekey.local/kse \
--set extension.imageRegistry=dockerhub.kubekey.local/kse</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch admon attention">
<colgroup>
<col style="width: 100%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">注意</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>将 <strong>global.imageRegistry</strong> 和 <strong>extension.imageRegistry</strong> 的默认地址 <strong>dockerhub.kubekey.local/kse</strong> 替换为您的实际镜像仓库地址。</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>取决于您的硬件和网络环境，您可能需要配置流量转发规则并在防火墙中放行 30880 端口。如果显示如下信息，则表明 ks-core 安装成功：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">NOTES:
Thank you for choosing KubeSphere Helm Chart.

Please be patient and wait for several seconds for the KubeSphere deployment to complete.

1. Wait for Deployment Completion

    Confirm that all KubeSphere components are running by executing the following command:

    kubectl get pods -n kubesphere-system

2. Access the KubeSphere Console

    Once the deployment is complete, you can access the KubeSphere console using the following URL:

    http://192.168.6.10:30880

3. Login to KubeSphere Console

    Use the following credentials to log in:

    Account: admin
    Password: P@88w0rd

NOTE: It is highly recommended to change the default password immediately after the first login.

For additional information and details, please visit https://kubesphere.io.</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>从成功信息中的 <strong>Console</strong>、<strong>Account</strong> 和 <strong>Password</strong> 参数分别获取 KubeSphere 企业版 Web 控制台的 IP 地址、管理员用户名和管理员密码，并使用网页浏览器登录 KubeSphere 企业版 Web 控制台。</p>
</li>
<li>
<p>根据激活提示点击<strong>激活</strong>，导入 KubeSphere 企业版的 license。</p>
</li>
<li>
<p>此时，Web 控制台仅提供 KubeSphere 企业版的核心功能，若要体验更多功能，还需在扩展中心<a href="../../../06-extension-user-guide/01-install-components/">安装扩展组件</a>。</p>
</li>
</ol>
</div>
</div>
</div>

    

  </div>
  <div class="post-footer">
    <div class="post-prev">
    </div>
    <div class="post-next">
    </div>
  </div>
  <div class="post-back-to-top">
    <span class="icon-up_3_fill"></span>
  </div>
</div>
<div class="post-placeholder"><div class="post-menu">
  <div class="post-menu-title">本页目录</div>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#_前提条件">前提条件</a></li>
    <li><a href="#_配置防火墙规则">配置防火墙规则</a></li>
    <li><a href="#_安装依赖项">安装依赖项</a></li>
    <li><a href="#_校验安装包完整性">校验安装包完整性</a></li>
    <li><a href="#_查看安装包内容">查看安装包内容</a></li>
    <li><a href="#_配置安装配置文件">配置安装配置文件</a></li>
    <li><a href="#_创建私有镜像仓库">创建私有镜像仓库</a></li>
    <li><a href="#_安装_kubernetes">安装 Kubernetes</a></li>
    <li><a href="#_导入镜像到私有镜像仓库">导入镜像到私有镜像仓库</a></li>
    <li><a href="#_安装kubesphere企业版">安装 KubeSphere 企业版</a></li>
  </ul>
</nav>
</div></div>
      </div>
    </div>
  </div>
</div></div>
    </body><script src="/js/bootstrap.min.js"></script>
<script src="/js/autocomplete/jquery.autocomplete.js"></script>
<script src="/js/copy-to-clipboard.js"></script>
<script src="/js/highlight.min.js"></script>
<script src="/js/jquery.tmpl.min.js"></script>
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="/js/search/jquery.mark.min.js"></script>

<script type="text/javascript" src="/js/common.0804ad48c7d18e84f98d818f8d8bf2606673ca5f9e919237311eff97b31b98061da1f72f95c4177ed55c843aa7b63025f5154d4651b46f49640309d80ba9972d.js" integrity="sha512-CAStSMfRjoT5jYGPjYvyYGZzyl&#43;ekZI3MR7/l7MbmAYdofcvlcQXftVchDqntjAl9RVNRlG0b0lkAwnYC6mXLQ=="></script>

<script type="text/javascript" src="/js/search.d8001c3e1b66b9a0b48e0c23ad0dbfc0906f194f8925ae78a9900b960679cfa7e41cebd9efd654f84535d02cbce7c4971f226e6f07288c26c3c4560c36d7655b.js"></script>
<script>
  $(function() {
    
    hljs.highlightAll();
    
    $.each($('.post-content .imageblock img'), function () {
      $(this).attr('data-mfp-src', $(this).attr('src'));
    });
    $('.post-content').magnificPopup({
      disableOn: function () {
        if ($(window).width() < 600) {
          return false;
        }
        return true;
      },
      delegate: '.imageblock img',
      type: 'image',
      gallery: {
        enabled: true,
      },
    });
  });
</script>
</html>
